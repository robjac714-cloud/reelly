<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Creators Media — بحث العقارات</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet (الخريطة) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --bg:#f4f7fc;
      --panel:#ffffff;
      --muted:#6c7b95;
      --text:#14213b;
      --stroke:#d4e0f5;
      --chip:#e3f2ff;
      --accent:#0078b8;
      --accent-2:#00a4ff;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:#f2f8ff;
      color:var(--text);
      font-family: Inter, "Cairo", system-ui, Tahoma;
    }

    /* ===== شاشة الترحيب ===== */
    #splash{
      position:fixed; inset:0;
      background:radial-gradient(circle at 50% 50%, #0078b8 0%, #005a86 70%, #02324f 100%);
      display:flex; align-items:center; justify-content:center;
      z-index:9999; color:#fff; font-family:"Cairo";
      animation:fadeOutSplash 1s ease forwards; animation-delay:2.3s;
    }
    .splash-inner{ text-align:center }
    .welcome-text{
      margin-top:18px; font-size:22px; font-weight:700;
    }
    @keyframes fadeOutSplash{
      to{ opacity:0; visibility:hidden; pointer-events:none; }
    }

    /* ===== Header ===== */
    .header{
      position:sticky; top:0; z-index:40;
      background:linear-gradient(90deg,#006ba6,#00a3ff);
      border-bottom:1px solid rgba(255,255,255,.25);
      color:#fff;
    }
    .header-inner{
      max-width:1400px; margin:0 auto; padding:12px 20px;
      display:flex; align-items:center; justify-content:center;
    }
    .brand-text{
      font-size:16px;
      font-weight:700;
      color:#fff;
      text-shadow:0 1px 2px rgba(0,0,0,.15);
    }

    /* Layout */
    .layout{
      max-width:1400px; margin:18px auto; padding:0 16px;
      display:grid; grid-template-columns:minmax(320px, 1.1fr) minmax(320px, 0.9fr); gap:18px;
      align-items:flex-start;
    }
    @media (max-width:900px){
      .layout{
        grid-template-columns:1fr;
      }
    }

    .panel{
      border:1px solid var(--stroke);
      background:var(--panel);
      border-radius:18px;
      box-shadow:0 8px 26px rgba(15,40,80,.08);
    }
    .panel-header{
      padding:10px 14px; border-bottom:1px solid var(--stroke);
      display:flex; align-items:center; justify-content:space-between;
    }
    .panel-body{ padding:14px }

    /* Map */
    .map-card{
      position:sticky;
      top:84px;
      height:calc(100vh - 110px);
      display:flex;
      flex-direction:column;
    }
    #liveMap{
      flex:1;
      width:100%;
      border-radius:0 0 18px 18px;
      overflow:hidden;
    }
    .toolbar{ display:flex; gap:8px; flex-wrap:wrap }

    /* ✅ موبايل: خريطة أصغر وغير لاصقة */
    @media (max-width:900px){
      .map-card{
        position:static;
        height:auto;
        margin-top:8px;
      }
      #liveMap{
        height:320px;
        border-radius:0 0 18px 18px;
      }
    }

    /* Form */
    form{
      display:grid; grid-template-columns:repeat(2, minmax(200px,1fr)); gap:12px 14px;
    }
    @media (max-width:720px){
      form{ grid-template-columns:1fr; }
    }
    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:4px }
    input,select{
      width:100%; padding:10px 12px; border-radius:12px; color:var(--text);
      border:1px solid var(--stroke); background:#f8fbff;
    }
    .full{ grid-column:1 / -1 }
    .actions{ display:flex; flex-wrap:wrap; gap:8px; margin-top:6px }
    button{
      padding:11px 16px; border-radius:999px; border:0; cursor:pointer;
      font-weight:700; font-size:13px;
    }
    .btn-primary{
      background:linear-gradient(90deg, var(--accent), var(--accent-2));
      color:#ffffff;
    }
    .btn-ghost{
      background:#ffffff;
      color:var(--accent);
      border:1px solid var(--stroke);
    }

    /* Chips (عامة) */
    .chips{
      display:flex; flex-wrap:wrap; gap:6px; margin-bottom:6px;
    }
    .chips button{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:#ffffff;
      color:var(--accent);
      font-size:11px;
      cursor:pointer;
    }
    .chips button.active{
      background:var(--accent);
      color:#ffffff;
      border-color:var(--accent);
    }

    /* Cards */
    .grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:16px; }
    .card{
      border:1px solid var(--stroke);
      background:#ffffff;
      border-radius:16px; overflow:hidden;
      transition:0.2s;
    }
    .card:hover{
      transform:translateY(-2px);
      box-shadow:0 12px 24px rgba(15,40,80,.15);
    }
    .thumb{ width:100%; aspect-ratio:16/10; object-fit:cover; background:#edf3ff }

    .summary{ font-size:13px; color:var(--muted); display:flex; justify-content:space-between }

    .chip{
      background:var(--chip);
      padding:6px 10px; border-radius:999px;
      font-size:12px; margin-left:4px;
    }
  </style>
</head>
<body>

  <!-- شاشة الترحيب -->
  <div id="splash">
    <div class="splash-inner">
      <div class="welcome-text">
        Platform by <strong>Creators Media</strong>
      </div>
    </div>
  </div>

  <!-- الهيدر -->
  <div class="header">
    <div class="header-inner">
      <div class="brand-text">
        Platform by <strong>Creators Media</strong>
      </div>
    </div>
  </div>

  <!-- باقي الصفحة -->
  <div class="layout">

    <!-- ✅ البحث أولاً (حتى بالموبايل يطلع فوق) -->
    <div class="panel">
      <div class="panel-body">
        <form id="searchForm">

          <!-- شيبس الكلمة المفتاحية -->
          <div class="full">
            <label>الكلمة المفتاحية</label>
            <div class="chips search-chips">
              <button type="button" data-val="Dubai">Dubai</button>
              <button type="button" data-val="Marina">Marina</button>
              <button type="button" data-val="Downtown">Downtown</button>
              <button type="button" data-val="Palm Jumeirah">Palm Jumeirah</button>
            </div>
            <input type="text" name="search_query" placeholder="Dubai / Marina">
          </div>

          <!-- البلد + شيبس للبلد -->
          <div>
            <label>البلد</label>
            <div class="chips country-chips">
              <button type="button" data-val="UAE">UAE</button>
              <button type="button" data-val="KSA">KSA</button>
              <button type="button" data-val="Qatar">Qatar</button>
            </div>
            <input type="text" name="country" placeholder="UAE">
          </div>

          <!-- المنطقة + شيبس للمنطقة -->
          <div>
            <label>المنطقة</label>
            <div class="chips region-chips">
              <button type="button" data-val="Dubai">Dubai</button>
              <button type="button" data-val="Abu Dhabi">Abu Dhabi</button>
              <button type="button" data-val="Sharjah">Sharjah</button>
              <button type="button" data-val="Ajman">Ajman</button>
            </div>
            <input type="text" name="region" placeholder="Dubai">
          </div>

          <!-- شيبس نطاق السعر -->
          <div class="full">
            <label>نطاق السعر (اختصار)</label>
            <div class="chips price-chips">
              <button type="button" data-from="" data-to="1000000">أقل من 1M</button>
              <button type="button" data-from="1000000" data-to="2000000">1M - 2M</button>
              <button type="button" data-from="2000000" data-to="">أكثر من 2M</button>
            </div>
          </div>

          <div>
            <label>السعر الأدنى</label>
            <input type="number" name="unit_price_from" placeholder="200000">
          </div>

          <div>
            <label>السعر الأعلى</label>
            <input type="number" name="unit_price_to" placeholder="1500000">
          </div>

          <!-- شيبس للمساحة -->
          <div class="full">
            <label>المساحة (اختصار)</label>
            <div class="chips area-chips">
              <button type="button" data-from="0" data-to="500">0–500</button>
              <button type="button" data-from="500" data-to="1000">500–1000</button>
              <button type="button" data-from="1000" data-to="1500">1000–1500</button>
            </div>
          </div>

          <div>
            <label>المساحة من</label>
            <input type="number" name="unit_area_from" placeholder="500">
          </div>

          <div>
            <label>المساحة إلى</label>
            <input type="number" name="unit_area_to" placeholder="1500">
          </div>

          <!-- المطور + شيبس -->
          <div class="full">
            <label>المطور</label>
            <div class="chips developer-chips">
              <button type="button" data-val="Emaar">Emaar</button>
              <button type="button" data-val="DAMAC">DAMAC</button>
              <button type="button" data-val="Nakheel">Nakheel</button>
              <button type="button" data-val="Meraas">Meraas</button>
            </div>
            <input type="text" name="developer" placeholder="Emaar / DAMAC">
          </div>

          <!-- عدد الغرف + شيبس -->
          <div class="full">
            <label>عدد الغرف</label>
            <div class="chips bedroom-chips">
              <button type="button" data-val="studio">استوديو</button>
              <button type="button" data-val="1">1 غرفة</button>
              <button type="button" data-val="2">2 غرف</button>
              <button type="button" data-val="3">3 غرف+</button>
            </div>
            <input type="text" name="unit_bedrooms" placeholder="studio,1,2,3">
          </div>

          <!-- أزرار جاهزة للمشاريع -->
          <div class="full actions">
            <button type="submit" class="btn-primary">بحث</button>
            <button type="button" id="dubaiProjects" class="btn-ghost">مشاريع دبي</button>
            <button type="button" id="abuDhabiProjects" class="btn-ghost">مشاريع أبوظبي</button>
            <button type="button" id="sharjahProjects" class="btn-ghost">مشاريع الشارقة</button>
            <button type="button" id="uaeProjects" class="btn-ghost">مشاريع الإمارات</button>
            <button type="reset" class="btn-ghost" id="resetBtn">إفراغ</button>
          </div>

        </form>
      </div>

      <!-- النتائج -->
      <div class="panel-body" style="border-top:1px solid var(--stroke)">
        <div class="summary">
          <div id="summaryText">—</div>
          <div id="debug"></div>
        </div>

        <div id="cards" class="grid" style="margin-top:16px"></div>
      </div>
    </div>

    <!-- ✅ الخريطة صارت العمود التاني -->
    <div class="panel map-card">
      <div class="panel-header">
        <div class="muted">الخريطة الحيّة (من النتائج الحالية)</div>
        <div class="toolbar">
          <button class="btn-ghost" id="regionMapBtn">خريطة المنطقة الحالية</button>
        </div>
      </div>
      <div id="liveMap"></div>
    </div>

  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    const API_BASE  = "https://search-listings-production.up.railway.app/v1/properties";
    const API_KEY   = "reelly-80fd5f24-WLrF9bAxkGwYrUXFjrIyzNxRlzrB4kpH";
    const API_KEY_HEADER = "X-API-Key";

    const form        = document.getElementById("searchForm");
    const cards       = document.getElementById("cards");
    const summaryEl   = document.getElementById("summaryText");
    const debugEl     = document.getElementById("debug");
    const regionBtn   = document.getElementById("regionMapBtn");
    const resetBtn    = document.getElementById("resetBtn");

    const dubaiBtn    = document.getElementById("dubaiProjects");
    const abuDhabiBtn = document.getElementById("abuDhabiProjects");
    const sharjahBtn  = document.getElementById("sharjahProjects");
    const uaeBtn      = document.getElementById("uaeProjects");

    let LAST_ITEMS = [];
    let MAP, MARKERS;

    function objectFromForm(f){
      const fd = new FormData(f);
      const o={};
      for(const [k,v] of fd.entries())
        if(v.trim()!=="") o[k]=v.trim();
      return o;
    }

    function buildParams(obj){
      const p=new URLSearchParams();
      Object.entries(obj).forEach(([k,v])=>p.append(k,v));
      return p.toString();
    }

    function tryParseJSON(s){
      try{ return JSON.parse(s) }catch{return null}
    }

    function isImg(u){
      return typeof u==="string" && /^https?:\/\//.test(u);
    }

    function getImage(it){
      if(typeof it.cover_image_url==="string"){
        const p = tryParseJSON(it.cover_image_url);
        if(p?.url) return p.url;
        if(isImg(it.cover_image_url)) return it.cover_image_url;
      }
      return "https://dummyimage.com/800x500/dde8ff/1c3558&text=No+Image";
    }

    function getCoords(it){
      if(typeof it.coordinates==="string"){
        const s = it.coordinates.split(",").map(n=>Number(n.trim()));
        if(s.length>=2) return {lat:s[0],lng:s[1]};
      }
      return null;
    }

    function renderCards(items){
      cards.innerHTML="";
      if(!items.length){
        cards.innerHTML="<div class='muted'>لا توجد نتائج.</div>";
        return;
      }

      items.forEach(it=>{
        const img = getImage(it);
        const c   = getCoords(it);
        const title = it.name || "بدون اسم";
        const dev   = it.developer || "--";
        const beds  = it.unit_bedrooms || "";
        const area  = it.area || it.unit_area || "";
        const price = it.min_price || it.price || "";
        const curr  = it.price_currency || "";

        const el = document.createElement("div");
        el.className="card";
        el.innerHTML=`
          <img src="${img}" class="thumb">
          <div class="card-body">
            <div class="title">${title}</div>

            <div>
             <span class="chip">${dev}</span>
             ${beds ? `<span class="chip">غرف: ${beds}</span>` : ""}
             ${area ? `<span class="chip">مساحة: ${area}</span>` : ""}
             ${price? `<span class="chip">${price} ${curr}</span>`:""}
            </div><br>

            <a
              ${c? `href="https://maps.google.com/?q=${c.lat},${c.lng}" target="_blank"`:"disabled"}
              class="btn-ghost"
              style="padding:8px 10px; text-align:center; display:block;"
            >
              ${c?"فتح على الخريطة":"لا توجد إحداثيات"}
            </a>
          </div>
        `;
        cards.appendChild(el);
      });
    }

    function initMap(){
      if(MAP) return;
      MAP = L.map('liveMap').setView([25.2048,55.2708], 10);
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(MAP);
      MARKERS = L.layerGroup().addTo(MAP);
    }

    function updateMap(items){
      initMap();
      MARKERS.clearLayers();
      const pts=[];
      items.forEach(it=>{
        const c=getCoords(it);
        if(!c) return;
        pts.push([c.lat,c.lng]);
        MARKERS.addLayer(
          L.marker([c.lat,c.lng]).bindPopup(it.name||"")
        );
      });

      if(pts.length) MAP.fitBounds(pts,{padding:[20,20]});
    }

    async function smartFetch(payload){
      const qs = buildParams(payload);

      // 1) GET
      let url = `${API_BASE}?${qs}`;
      let r = await fetch(url,{
        method:"GET",
        headers:{
          [API_KEY_HEADER]:API_KEY,
          accept:"application/json"
        }
      });
      if(r.ok) return {r,url};

      // 2) POST fallback
      url = API_BASE;
      r = await fetch(url,{
        method:"POST",
        headers:{
          [API_KEY_HEADER]:API_KEY,
          "Content-Type":"application/json"
        },
        body:JSON.stringify(payload)
      });
      if(r.ok) return {r,url};

      // 3) Query fallback
      url = `${API_BASE}?${qs}&api_key=${API_KEY}`;
      r = await fetch(url);
      return {r,url};
    }

    async function runSearch(payload){
      summaryEl.textContent="—";
      cards.innerHTML="";

      const {r,url} = await smartFetch(payload);
      const txt = await r.text();
      let data={}; try{ data=JSON.parse(txt) }catch{}

      debugEl.textContent=`Status: ${r.status}`;

      if(!r.ok){
        summaryEl.textContent="فشل الجلب";
        return;
      }

      const items = data.items || data.data || data.results || [];
      LAST_ITEMS = items;

      summaryEl.textContent=`النتائج: ${items.length}`;

      renderCards(items);
      updateMap(items);
    }

    form.addEventListener("submit", e=>{
      e.preventDefault();
      runSearch(objectFromForm(form));
    });

    resetBtn.addEventListener("click", ()=>{
      clearAllChipActive();
      cards.innerHTML="";
      summaryEl.textContent="—";
      debugEl.textContent="";
    });

    regionBtn.addEventListener("click", ()=>{
      updateMap(LAST_ITEMS);
    });

    function clearAllChipActive(){
      document.querySelectorAll(".chips button")
      .forEach(b=>b.classList.remove("active"));
    }

    /* ==== شيبس بسيطة (قيمة واحدة) ==== */
    function bindChipGroup(selector,input){
      const chips=document.querySelectorAll(selector+" button");
      chips.forEach(btn=>{
        btn.addEventListener("click", ()=>{
          chips.forEach(b=>b.classList.remove("active"));
          btn.classList.add("active");
          input.value = btn.dataset.val || "";
          runSearch(objectFromForm(form));
        });
      });
    }

    bindChipGroup(".search-chips",  form.elements["search_query"]);
    bindChipGroup(".country-chips", form.elements["country"]);
    bindChipGroup(".region-chips",  form.elements["region"]);
    bindChipGroup(".developer-chips", form.elements["developer"]);
    bindChipGroup(".bedroom-chips", form.elements["unit_bedrooms"]);

    /* ==== شيبس السعر (من/إلى) ==== */
    const priceChips=document.querySelectorAll(".price-chips button");
    const priceFrom=form.elements["unit_price_from"];
    const priceTo=form.elements["unit_price_to"];
    priceChips.forEach(btn=>{
      btn.addEventListener("click", ()=>{
        priceChips.forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        priceFrom.value = btn.dataset.from || "";
        priceTo.value   = btn.dataset.to   || "";
        runSearch(objectFromForm(form));
      });
    });

    /* ==== شيبس المساحة (من/إلى) ==== */
    const areaChips=document.querySelectorAll(".area-chips button");
    const areaFrom=form.elements["unit_area_from"];
    const areaTo=form.elements["unit_area_to"];
    areaChips.forEach(btn=>{
      btn.addEventListener("click", ()=>{
        areaChips.forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        areaFrom.value = btn.dataset.from || "";
        areaTo.value   = btn.dataset.to   || "";
        runSearch(objectFromForm(form));
      });
    });

    /* ==== أزرار المشاريع الجاهزة ==== */
    function presetProjects({country,region,query}){
      form.reset();
      clearAllChipActive();
      if(country) form.elements["country"].value=country;
      if(region)  form.elements["region"].value=region;
      if(query)   form.elements["search_query"].value=query;
      runSearch(objectFromForm(form));
    }

    dubaiBtn.addEventListener("click", ()=>{
      presetProjects({country:"UAE",region:"Dubai",query:"Dubai"});
    });

    abuDhabiBtn.addEventListener("click", ()=>{
      presetProjects({country:"UAE",region:"Abu Dhabi",query:"Abu Dhabi"});
    });

    sharjahBtn.addEventListener("click", ()=>{
      presetProjects({country:"UAE",region:"Sharjah",query:"Sharjah"});
    });

    uaeBtn.addEventListener("click", ()=>{
      presetProjects({country:"UAE",region:"",query:"UAE"});
    });

    /* تشغيل أولي */
    runSearch({search_query:"Dubai",per_page:"12"});
  </script>

</body>
</html>
